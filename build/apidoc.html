<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/JamieMason/shrinkpack"

    >shrinkpack (v0.18.1)</a>
</h1>
<h4>Fast, resilient, reproducible builds with npm install.</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.shrinkpack">module shrinkpack</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.analyse">
            function <span class="apidocSignatureSpan">shrinkpack.</span>analyse
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.cli">
            function <span class="apidocSignatureSpan">shrinkpack.</span>cli
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.update">
            function <span class="apidocSignatureSpan">shrinkpack.</span>update
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">shrinkpack.</span>child_process</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">shrinkpack.</span>fs</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">shrinkpack.</span>index</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.shrinkpack.child_process">module shrinkpack.child_process</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.child_process.exec">
            function <span class="apidocSignatureSpan">shrinkpack.child_process.</span>exec
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.child_process.spawn">
            function <span class="apidocSignatureSpan">shrinkpack.child_process.</span>spawn
            <span class="apidocSignatureSpan">(cmd, args, opts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.shrinkpack.fs">module shrinkpack.fs</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.createReadStream">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>createReadStream
            <span class="apidocSignatureSpan">(path, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.createWriteStream">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>createWriteStream
            <span class="apidocSignatureSpan">(path, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.mkdir">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>mkdir
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.readFile">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>readFile
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.readdir">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>readdir
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.unlink">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>unlink
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.fs.writeFile">
            function <span class="apidocSignatureSpan">shrinkpack.fs.</span>writeFile
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.shrinkpack.index">module shrinkpack.index</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.index.analyse">
            function <span class="apidocSignatureSpan">shrinkpack.index.</span>analyse
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.index.cli">
            function <span class="apidocSignatureSpan">shrinkpack.index.</span>cli
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.shrinkpack.index.update">
            function <span class="apidocSignatureSpan">shrinkpack.index.</span>update
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.shrinkpack" id="apidoc.module.shrinkpack">module shrinkpack</a></h1>


    <h2>
        <a href="#apidoc.element.shrinkpack.analyse" id="apidoc.element.shrinkpack.analyse">
        function <span class="apidocSignatureSpan">shrinkpack.</span>analyse
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function init(options) {
  return when({options: options, startTime: new Date()})
    .then(getConfigWithPaths)
    .then(getConfigWithGraph)
    .then(handleOptionalDependencies)
    .then(ensureBundleExists)
    .then(getConfigWithNpmCacheContents)
    .then(getConfigWithBundleContents)
    .then(getConfigWithDependencies)
    .then(getConfigWithUnusedDependencies)
    .then(getConfigWithStats);

  function getConfigWithPaths(config) {
    return getPaths(config.options.directory)
      .then(function (paths) {
        return assign(config, {path: paths});
      });
  }

  function getConfigWithGraph(config) {
    return getGraph(config.path.graph)
      .then(function (graph) {
        return assign(config, {graph: graph});
      });
  }

  function handleOptionalDependencies(config) {
    return pruneOptionalDependencies(config)
      .then(function (graph) {
        return assign(config, {graph: graph});
      });
  }

  function ensureBundleExists(config) {
    return createBundleDirectory(config.path.shrinkpack)
      .then(function () {
        return config;
      });
  }

  function getConfigWithNpmCacheContents(config) {
    return readNpmCache(config.path.npmCache)
      .then(function (npmCache) {
        return assign(config, {npmCache: npmCache});
      });
  }

  function getConfigWithBundleContents(config) {
    return readBundle(config.path.shrinkpack)
      .then(function (bundle) {
        return assign(config, {bundle: bundle});
      });
  }

  function getConfigWithDependencies(config) {
    return getDependencies(config)
      .then(function (deps) {
        return assign(config, {deps: deps});
      });
  }

  function getConfigWithUnusedDependencies(config) {
    return getUnusedDependencies(config)
      .then(function (unusedDependencies) {
        return assign(config, {unusedDependencies: unusedDependencies});
      });
  }

  function getConfigWithStats(config) {
    return getStats(config)
      .then(function (stats) {
        return assign(config, {stats: stats});
      });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1. Analyse the project and gather all the diffing information between the file system and the shrinkwrap.
2. Use the diffing information to bring the file system in sync with the shrinkwrap.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);

shrinkpack.<span class="apidocCodeKeywordSpan">analyse</span>({ compress: false, directory: process.cwd(), keepOptional: false })
  .then(data =&#x3e; shrinkpack.update(data));
```

Or to run `shrinkpack` in full, including all the additional logging that you see when using the CLI.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.cli" id="apidoc.element.shrinkpack.cli">
        function <span class="apidocSignatureSpan">shrinkpack.</span>cli
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function runCli(options) {
  return analyse(options)
    .then(update, onFail)
    .then(displaySummary, onFail)
    .catch(onFail);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```

Or to run `shrinkpack` in full, including all the additional logging that you see when using the CLI.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);

shrinkpack.<span class="apidocCodeKeywordSpan">cli</span>({ compress: false, directory: process.cwd(), keepOptional: false })
  .then(() =&#x3e; {});
```

## Target Problem

On most projects I&#x27;ve worked on we&#x27;ve had a [Jenkins](http://jenkins-ci.org/) (or similiar)
continuous integration environment, where we would run tests, analyse code, gather metrics, and
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.update" id="apidoc.element.shrinkpack.update">
        function <span class="apidocSignatureSpan">shrinkpack.</span>update
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function update(config) {
  return when.join(
    addUsedDependencies(config),
    deleteUnusedDependencies(config)
  ).then(function () {
    return rewriteGraph(config);
  }).then(function () {
    return config;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
1. Analyse the project and gather all the diffing information between the file system and the shrinkwrap.
2. Use the diffing information to bring the file system in sync with the shrinkwrap.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);

shrinkpack.analyse({ compress: false, directory: process.cwd(), keepOptional: false })
  .then(data =&#x3e; shrinkpack.<span class="apidocCodeKeywordSpan">update</span>(data));
```

Or to run `shrinkpack` in full, including all the additional logging that you see when using the CLI.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);
...</pre></li>
    </ul>








</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.shrinkpack.child_process" id="apidoc.module.shrinkpack.child_process">module shrinkpack.child_process</a></h1>


    <h2>
        <a href="#apidoc.element.shrinkpack.child_process.exec" id="apidoc.element.shrinkpack.child_process.exec">
        function <span class="apidocSignatureSpan">shrinkpack.child_process.</span>exec
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">exec = function () {
			var args = slice.call(arguments);

			return when(condition()).withThis(this).then(function(exit) {
				return when(f.apply(this, args))[&#x27;finally&#x27;](exit);
			});
		}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var childProcess = require(&#x27;../lib/child-process&#x27;);

// public
module.exports = getPaths;

// implementation
function getPaths(directory) {
return childProcess.<span class="apidocCodeKeywordSpan">exec</span>(&#x27;npm config get cache&#x27;, {encoding: &#x27;utf8&#x27
;})
  .then(onSuccess, onError);

function onSuccess(result) {
  return {
    graph: path.join(directory, &#x27;npm-shrinkwrap.json&#x27;),
    manifest: path.join(directory, &#x27;package.json&#x27;),
    npmCache: result.stdout,
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.child_process.spawn" id="apidoc.element.shrinkpack.child_process.spawn">
        function <span class="apidocSignatureSpan">shrinkpack.child_process.</span>spawn
        <span class="apidocSignatureSpan">(cmd, args, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">(cmd, args, opts) =&#x3e; {
	let joinedCmd = cmd;

	if (Array.isArray(args) &#x26;&#x26; args.length &#x3e; 0) {
		joinedCmd += &#x27; &#x27; + args.join(&#x27; &#x27;);
	}

	const parsed = handleArgs(cmd, args, opts);
	const encoding = parsed.opts.encoding;
	const maxBuffer = parsed.opts.maxBuffer;

	let spawned;
	try {
		spawned = childProcess.spawn(parsed.cmd, parsed.args, parsed.opts);
	} catch (err) {
		return Promise.reject(err);
	}

	let removeExitHandler;
	if (parsed.opts.cleanup) {
		removeExitHandler = onExit(() =&#x3e; {
			spawned.kill();
		});
	}

	const promise = Promise.all([
		processDone(spawned),
		getStream(spawned, &#x27;stdout&#x27;, encoding, maxBuffer),
		getStream(spawned, &#x27;stderr&#x27;, encoding, maxBuffer)
	]).then(arr =&#x3e; {
		const result = arr[0];
		const stdout = arr[1];
		const stderr = arr[2];

		let err = result.err;
		const code = result.code;
		const signal = result.signal;

		if (removeExitHandler) {
			removeExitHandler();
		}

		if (err || code !== 0 || signal !== null) {
			if (!err) {
				err = new Error(`Command failed: ${joinedCmd}\n${stderr}${stdout}`);
				err.code = code &#x3c; 0 ? errname(code) : code;
			}

			// TODO: missing some timeout logic for killed
			// https://github.com/nodejs/node/blob/master/lib/child_process.js#L203
			// err.killed = spawned.killed || killed;
			err.killed = err.killed || spawned.killed;

			err.stdout = stdout;
			err.stderr = stderr;
			err.failed = true;
			err.signal = signal || null;
			err.cmd = joinedCmd;

			if (!parsed.opts.reject) {
				return err;
			}

			throw err;
		}

		return {
			stdout: handleOutput(parsed.opts, stdout),
			stderr: handleOutput(parsed.opts, stderr),
			code: 0,
			failed: false,
			killed: false,
			signal: null,
			cmd: joinedCmd
		};
	});

	crossSpawn._enoent.hookChildProcess(spawned, parsed);

	handleInput(spawned, parsed.opts);

	spawned.then = promise.then.bind(promise);
	spawned.catch = promise.catch.bind(promise);

	return spawned;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
.then(toArray)
.then(getPackages)
.then(indexByPath);

  function getCacheContents() {
var allData = &#x27;&#x27;;
var deferred = when.defer();
var npmCache = childProcess.<span class="apidocCodeKeywordSpan">spawn</span>(&#x27;npm&#x27;, [&#x27;cache&#x27;, &#x27;ls&#x27;]);

npmCache.stdout.setEncoding(&#x27;utf8&#x27;);
npmCache.stdout.on(&#x27;data&#x27;, onData);
npmCache.on(&#x27;close&#x27;, onClose);

return deferred.promise;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.shrinkpack.fs" id="apidoc.module.shrinkpack.fs">module shrinkpack.fs</a></h1>


    <h2>
        <a href="#apidoc.element.shrinkpack.fs.createReadStream" id="apidoc.element.shrinkpack.fs.createReadStream">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>createReadStream
        <span class="apidocSignatureSpan">(path, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function createReadStream(path, options) {
  return new ReadStream(path, options)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// public
module.exports = rateLimit(copyFile);

// implementation
function copyFile(source, target) {
  return when.promise(function (resolve, reject) {
var gunzip$;
var read$ = fs.<span class="apidocCodeKeywordSpan">createReadStream</span>(source);
var write$ = fs.createWriteStream(target);

read$.on(&#x27;error&#x27;, onReadError);
write$.on(&#x27;error&#x27;, onWriteError);
write$.on(&#x27;finish&#x27;, onWriteEnd);

if (isCompressed()) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.fs.createWriteStream" id="apidoc.element.shrinkpack.fs.createWriteStream">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>createWriteStream
        <span class="apidocSignatureSpan">(path, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function createWriteStream(path, options) {
  return new WriteStream(path, options)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
module.exports = rateLimit(copyFile);

// implementation
function copyFile(source, target) {
  return when.promise(function (resolve, reject) {
var gunzip$;
var read$ = fs.createReadStream(source);
var write$ = fs.<span class="apidocCodeKeywordSpan">createWriteStream</span>(target);

read$.on(&#x27;error&#x27;, onReadError);
write$.on(&#x27;error&#x27;, onWriteError);
write$.on(&#x27;finish&#x27;, onWriteEnd);

if (isCompressed()) {
  read$.pipe(write$);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.fs.mkdir" id="apidoc.element.shrinkpack.fs.mkdir">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>mkdir
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">mkdir = function () {
			var args = slice.call(arguments);

			return when(condition()).withThis(this).then(function(exit) {
				return when(f.apply(this, args))[&#x27;finally&#x27;](exit);
			});
		}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var fs = require(&#x27;../lib/fs&#x27;);

// public
module.exports = createBundleDirectory;

// implementation
function createBundleDirectory(location) {
return fs.<span class="apidocCodeKeywordSpan">mkdir</span>(location)
  .then(onSuccess, onError);

function onSuccess() {
  return location;
}

function onError(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.fs.readFile" id="apidoc.element.shrinkpack.fs.readFile">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>readFile
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">readFile = function () {
			var args = slice.call(arguments);

			return when(condition()).withThis(this).then(function(exit) {
				return when(f.apply(this, args))[&#x27;finally&#x27;](exit);
			});
		}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var fs = require(&#x27;../lib/fs&#x27;);

// public
module.exports = getGraph;

// implementation
function getGraph(location) {
return fs.<span class="apidocCodeKeywordSpan">readFile</span>(location, {encoding: &#x27;utf8&#x27;})
  .then(onSuccess, onError);

function onSuccess(graph) {
  return JSON.parse(graph);
}

function onError() {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.fs.readdir" id="apidoc.element.shrinkpack.fs.readdir">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>readdir
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">readdir = function () {
			var args = slice.call(arguments);

			return when(condition()).withThis(this).then(function(exit) {
				return when(f.apply(this, args))[&#x27;finally&#x27;](exit);
			});
		}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var fs = require(&#x27;../lib/fs&#x27;);

// public
module.exports = readBundle;

// implementation
function readBundle(pathToBundle) {
return fs.<span class="apidocCodeKeywordSpan">readdir</span>(pathToBundle)
  .then(indexByPath, onError);

function indexByPath(filenames) {
  return filenames.reduce(function (memo, filename) {
    memo[getAbsolutePath(filename)] = true;
    return memo;
  }, {});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.fs.unlink" id="apidoc.element.shrinkpack.fs.unlink">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>unlink
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unlink = function () {
			var args = slice.call(arguments);

			return when(condition()).withThis(this).then(function(exit) {
				return when(f.apply(this, args))[&#x27;finally&#x27;](exit);
			});
		}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var fs = require(&#x27;./fs&#x27;);

// public
module.exports = deleteFile;

// implementation
function deleteFile(location) {
return fs.<span class="apidocCodeKeywordSpan">unlink</span>(location)
  .then(onSuccess, onError);

function onSuccess() {
  return location;
}

function onError() {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.fs.writeFile" id="apidoc.element.shrinkpack.fs.writeFile">
        function <span class="apidocSignatureSpan">shrinkpack.fs.</span>writeFile
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">writeFile = function () {
			var args = slice.call(arguments);

			return when(condition()).withThis(this).then(function(exit) {
				return when(f.apply(this, args))[&#x27;finally&#x27;](exit);
			});
		}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// public
module.exports = getGraph;

// implementation
function getGraph(config) {
console.log(chalk.blue(&#x27;i rewriting &#x27; + config.path.graph));
return fs.<span class="apidocCodeKeywordSpan">writeFile</span>(config.path.graph, JSON.stringify(config.graph, null, 2), {encoding
: &#x27;utf8&#x27;})
  .then(onSuccess, onError);

function onSuccess() {
  return config.path.graph;
}

function onError() {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.shrinkpack.index" id="apidoc.module.shrinkpack.index">module shrinkpack.index</a></h1>


    <h2>
        <a href="#apidoc.element.shrinkpack.index.analyse" id="apidoc.element.shrinkpack.index.analyse">
        function <span class="apidocSignatureSpan">shrinkpack.index.</span>analyse
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function init(options) {
  return when({options: options, startTime: new Date()})
    .then(getConfigWithPaths)
    .then(getConfigWithGraph)
    .then(handleOptionalDependencies)
    .then(ensureBundleExists)
    .then(getConfigWithNpmCacheContents)
    .then(getConfigWithBundleContents)
    .then(getConfigWithDependencies)
    .then(getConfigWithUnusedDependencies)
    .then(getConfigWithStats);

  function getConfigWithPaths(config) {
    return getPaths(config.options.directory)
      .then(function (paths) {
        return assign(config, {path: paths});
      });
  }

  function getConfigWithGraph(config) {
    return getGraph(config.path.graph)
      .then(function (graph) {
        return assign(config, {graph: graph});
      });
  }

  function handleOptionalDependencies(config) {
    return pruneOptionalDependencies(config)
      .then(function (graph) {
        return assign(config, {graph: graph});
      });
  }

  function ensureBundleExists(config) {
    return createBundleDirectory(config.path.shrinkpack)
      .then(function () {
        return config;
      });
  }

  function getConfigWithNpmCacheContents(config) {
    return readNpmCache(config.path.npmCache)
      .then(function (npmCache) {
        return assign(config, {npmCache: npmCache});
      });
  }

  function getConfigWithBundleContents(config) {
    return readBundle(config.path.shrinkpack)
      .then(function (bundle) {
        return assign(config, {bundle: bundle});
      });
  }

  function getConfigWithDependencies(config) {
    return getDependencies(config)
      .then(function (deps) {
        return assign(config, {deps: deps});
      });
  }

  function getConfigWithUnusedDependencies(config) {
    return getUnusedDependencies(config)
      .then(function (unusedDependencies) {
        return assign(config, {unusedDependencies: unusedDependencies});
      });
  }

  function getConfigWithStats(config) {
    return getStats(config)
      .then(function (stats) {
        return assign(config, {stats: stats});
      });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

1. Analyse the project and gather all the diffing information between the file system and the shrinkwrap.
2. Use the diffing information to bring the file system in sync with the shrinkwrap.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);

shrinkpack.<span class="apidocCodeKeywordSpan">analyse</span>({ compress: false, directory: process.cwd(), keepOptional: false })
  .then(data =&#x3e; shrinkpack.update(data));
```

Or to run `shrinkpack` in full, including all the additional logging that you see when using the CLI.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.index.cli" id="apidoc.element.shrinkpack.index.cli">
        function <span class="apidocSignatureSpan">shrinkpack.index.</span>cli
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function runCli(options) {
  return analyse(options)
    .then(update, onFail)
    .then(displaySummary, onFail)
    .catch(onFail);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```

Or to run `shrinkpack` in full, including all the additional logging that you see when using the CLI.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);

shrinkpack.<span class="apidocCodeKeywordSpan">cli</span>({ compress: false, directory: process.cwd(), keepOptional: false })
  .then(() =&#x3e; {});
```

## Target Problem

On most projects I&#x27;ve worked on we&#x27;ve had a [Jenkins](http://jenkins-ci.org/) (or similiar)
continuous integration environment, where we would run tests, analyse code, gather metrics, and
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.shrinkpack.index.update" id="apidoc.element.shrinkpack.index.update">
        function <span class="apidocSignatureSpan">shrinkpack.index.</span>update
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function update(config) {
  return when.join(
    addUsedDependencies(config),
    deleteUnusedDependencies(config)
  ).then(function () {
    return rewriteGraph(config);
  }).then(function () {
    return config;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
1. Analyse the project and gather all the diffing information between the file system and the shrinkwrap.
2. Use the diffing information to bring the file system in sync with the shrinkwrap.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);

shrinkpack.analyse({ compress: false, directory: process.cwd(), keepOptional: false })
  .then(data =&#x3e; shrinkpack.<span class="apidocCodeKeywordSpan">update</span>(data));
```

Or to run `shrinkpack` in full, including all the additional logging that you see when using the CLI.

```js
var shrinkpack = require(&#x27;shrinkpack&#x27;);
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
